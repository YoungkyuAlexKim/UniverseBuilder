<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scenario Universe Builder</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" href="/static/css/main.css?v=1.6"> 
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    
    <script type="module" src="/static/js/main.js?v=2.0"></script>
</head>
<body>
    <div class="grid-container">
        <aside class="sidebar">
            <div class="project-list-container">
                <hgroup><h3>🗂️ 프로젝트</h3></hgroup>
                <ul class="project-list"><li aria-busy="true">프로젝트 로딩 중...</li></ul>
            </div>
            <div>
                <form id="create-project-form">
                    <input type="text" name="name" placeholder="새 프로젝트 이름..." required autocomplete="off">
                    <button type="submit">프로젝트 추가</button>
                </form>
                <hgroup><h3>✨ AI 모델</h3></hgroup>
                <form>
                    <label for="ai-model-select">사용할 모델 선택</label>
                    <select id="ai-model-select">
                        <option value="gemini-2.5-flash-lite">Gemini-2.5 Flash Lite (빠름)</option>
                        <option value="gemini-2.5-flash" selected>Gemini-2.5 Flash (기본값, 추천)</option>
                    </select>
                </form>
            </div>
        </aside>

        <div class="resizer" id="resizer"></div>

        <main class="main-content">
            <div id="welcome-view" class="content-view active">
                <hgroup><h1>시나리오 유니버스 빌더</h1><h2>좌측 메뉴에서 작업을 선택해주세요.</h2></hgroup>
                <p>이곳에 선택된 메뉴의 UI가 나타납니다.</p>
            </div>
            
            <div id="project-detail-view" class="content-view">
                <hgroup><h1 id="project-title-display"></h1></hgroup>
                <nav>
                    <ul>
                        <li><a href="#" class="tab-link active" data-tab="characters">캐릭터</a></li>
                        <li><a href="#" class="tab-link" data-tab="worldview">세계관</a></li>
                        <li><a href="#" class="tab-link" data-tab="scenario">시나리오</a></li> </ul>
                </nav>
                <div id="tab-content-characters" class="tab-content active">
                    <div id="card-list-container"></div> 
                </div>

                <div id="tab-content-worldview" class="tab-content">
                    <article>
                        <hgroup>
                            <h4>메인 세계관 (무대 설정)</h4>
                            <p>이야기가 펼쳐질 '무대'의 규칙과 설정을 정의하는 공간입니다.</p>
                        </hgroup>
                        <form id="worldview-form">
                            <label for="worldview-logline">한 줄 정의 (Logline)</label>
                            <input type="text" id="worldview-logline" name="logline" placeholder="이 세계를 한 문장으로 정의합니다. (예: 마법이 기술을 대체한 스팀펑크 세계)">

                            <label for="worldview-genre">장르 및 분위기 (Genre & Tone)</label>
                            <input type="text" id="worldview-genre" name="genre" placeholder="이 세계의 장르와 전반적인 분위기를 설명합니다. (예: 다크 판타지, 희망적인 디스토피아)">

                            <label>세계관 핵심 설정</label>
                            <div id="worldview-rules-container" class="dynamic-input-container" style="gap: 0.5rem; margin-bottom: 0.5rem;">
                                <!-- 핵심 설정 필드가 여기에 동적으로 추가됩니다. -->
                            </div>
                            <button type="button" id="add-worldview-rule-btn" class="secondary outline" style="width: 100%;">+ 핵심 설정 추가</button>
                            
                            <button type="submit" id="save-worldview-btn" style="margin-top: 1.5rem;">메인 세계관 저장</button>
                        </form>
                    </article>
                    <hr>
                    <h4>서브 설정 카드</h4>
                    <div id="worldview-card-list-container">
                        <!-- 서브 설정 카드들이 여기에 동적으로 렌더링됩니다. -->
                    </div>
                </div>

                <div id="tab-content-scenario" class="tab-content">
                    <article>
                        <hgroup>
                            <h4>메인 스토리 (사건의 흐름)</h4>
                            <p>세계관이라는 무대 위에서 벌어지는 구체적인 '사건'의 흐름을 설계하는 공간입니다.</p>
                        </hgroup>
                        <form id="scenario-details-form">
                            <label for="scenario-summary">이야기 핵심 컨셉 (Logline)</label>
                            <input type="text" id="scenario-summary" name="summary" placeholder="이 이야기를 한 문장으로 요약합니다. (예: 몰락한 왕국의 기사가 현대로 넘어와 자신의 세계를 구원할 방법을 찾는다.)">
                            
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label for="scenario-synopsis">시놉시스 / 전체 줄거리 (Synopsis)</label>
                                <button type="button" id="enhance-synopsis-btn" class="secondary outline" style="width: auto; font-size: 0.9rem;">✨ AI 스토리 구체화</button>
                            </div>
                            <textarea id="scenario-synopsis" name="synopsis" rows="5" placeholder="이야기의 전체적인 흐름과 구조를 자유롭게 서술합니다. 한 줄 아이디어부터 상세한 줄거리까지, AI와 함께 발전시켜 나갈 수 있습니다."></textarea>

                            <div class="grid">
                                <label for="scenario-title">
                                    시나리오 제목
                                    <input type="text" id="scenario-title" name="title" placeholder="시나리오의 제목">
                                </label>
                                <label for="scenario-themes">
                                    핵심 테마 (쉼표로 구분)
                                    <input type="text" id="scenario-themes" name="themes" placeholder="예: 복수, 희생, 구원">
                                </label>
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; align-items: center; margin-top: 1rem;">
                                <button type="button" id="refine-concept-btn" class="secondary" style="width: auto; flex-grow: 0;">✨ 컨셉 다듬기 (AI)</button>
                                <div style="flex-grow: 1;"></div>
                                <button type="button" id="ai-draft-btn" class="contrast" style="width: auto;">✨ AI로 전체 스토리 초안 생성</button>
                                <button type="submit" style="width: auto;">시나리오 정보 저장</button>
                            </div>
                        </form>
                    </article>
                    <hr>
                    <div id="plot-points-container">
                        <h4>플롯 포인트</h4>
                        <div id="plot-list">
                            <!-- 플롯 포인트들이 여기에 동적으로 렌더링됩니다. -->
                        </div>
                        <form id="add-plot-point-form" style="margin-top: 1.5rem; border-top: 1px solid var(--pico-muted-border-color); padding-top: 1.5rem;">
                            <label for="new-plot-title"><strong>새 플롯 추가</strong></label>
                            <input type="text" id="new-plot-title" name="title" placeholder="플롯 제목 (예: 주인공의 각성)" required>
                            <textarea name="content" rows="3" placeholder="세부 내용 (선택 사항)"></textarea>
                            <button type="submit" style="width: auto;">+ 플롯 추가</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-backdrop"></div>

    <div id="card-details-modal" class="modal-container">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close"></a>
                <h3 id="modal-card-name"></h3>
            </header>
            <div id="modal-card-content">
            </div>
            <footer class="grid" id="modal-card-footer">
            </footer>
        </article>
    </div>
    
    <div id="worldview-card-modal" class="modal-container">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close"></a>
                <h3 id="worldview-modal-title">세계관 설정 카드</h3>
            </header>
            <form id="worldview-card-form">
                <input type="text" id="worldview-modal-card-title" name="title" placeholder="설정 제목 (예: 마법의 원리)" required>
                <textarea id="worldview-modal-card-content" name="content" rows="12" placeholder="세부 내용을 입력하세요..."></textarea>
                <button type="submit" id="worldview-modal-save-btn">저장</button>
            </form>
        </article>
    </div>
    
    <div id="ai-diff-modal" class="modal-container">
        <article style="max-width: 90vw; width: 1200px;">
            <header>
                <a href="#close" aria-label="Close" class="close"></a>
                <h3>AI 수정 제안 검토</h3>
            </header>
            <div id="ai-diff-container" class="grid">
                <article>
                    <header><strong>원본 내용</strong></header>
                    <div id="ai-diff-original"></div>
                </article>
                <article>
                    <header><strong>AI 수정 제안</strong></header>
                    <div id="ai-diff-suggestion"></div>
                </article>
            </div>
            <footer>
                <div class="grid" style="justify-content: flex-end;">
                    <button id="ai-diff-reject-btn" class="secondary outline" style="width: auto;">반려</button>
                    <button id="ai-diff-accept-btn" style="width: auto;">이 내용으로 적용</button>
                </div>
            </footer>
        </article>
    </div>

    <div id="ai-scenario-draft-modal" class="modal-container">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close"></a>
                <h3>✨ AI 스토리 초안 생성</h3>
            </header>
            <form id="ai-scenario-draft-form">
                <label for="plot-point-count">생성할 플롯 개수: <strong id="plot-point-count-value">10</strong>개</label>
                <input type="range" id="plot-point-count" name="plot_point_count" value="10" min="5" max="25" step="1">
                
                <label for="scenario-characters" style="margin-top: 1rem;">주요 등장인물 선택</label>
                <div id="scenario-characters-container" class="checkbox-container" style="max-height: 200px;">
                    <p>캐릭터 정보 로딩 중...</p>
                </div>
                <footer>
                    <button type="submit" id="generate-ai-draft-btn">생성하기</button>
                </footer>
            </form>
        </article>
    </div>

    <div id="plot-point-edit-modal" class="modal-container">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close"></a>
                <h3>플롯 포인트 편집</h3>
            </header>
            <form id="plot-point-edit-form">
                <input type="hidden" name="plot_point_id">
                <label for="plot-point-title">
                    제목
                    <input type="text" id="plot-point-title" name="title" required>
                </label>
                <label for="plot-point-content">
                    내용
                    <textarea id="plot-point-content" name="content" rows="8"></textarea>
                </label>
            </form>
            <footer>
                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                    <button id="plot-point-delete-btn" class="secondary outline">삭제</button>
                    <button id="plot-point-ai-edit-btn" class="secondary">✨ AI로 수정</button>
                    <button id="plot-point-save-btn">수동으로 저장</button>
                </div>
            </footer>
        </article>
    </div>

    <div id="refine-concept-modal" class="modal-container">
        <article style="max-width: 90vw; width: 1000px;">
            <header>
                <a href="#close" aria-label="Close" class="close"></a>
                <h3>✨ AI 컨셉 다듬기 제안</h3>
            </header>
            <div class="grid">
                <article>
                    <header><strong>원본 컨셉</strong></header>
                    <div id="refine-concept-original" style="white-space: pre-wrap; padding: 1rem; border: 1px solid var(--pico-muted-border-color); border-radius: 6px; min-height: 100px;"></div>
                </article>
                <article>
                    <header><strong>AI 제안</strong></header>
                    <div id="refine-concept-suggestion" style="white-space: pre-wrap; padding: 1rem; border: 1px solid var(--pico-muted-border-color); border-radius: 6px; min-height: 100px;"></div>
                </article>
            </div>
            <footer>
                <div class="grid" style="justify-content: flex-end; grid-template-columns: repeat(3, auto); gap: 0.5rem;">
                    <button id="refine-concept-reject-btn" class="secondary outline" style="width: auto;">반려</button>
                    <button id="refine-concept-reroll-btn" class="secondary" style="width: auto;">다시 시도 (Re-roll)</button>
                    <button id="refine-concept-accept-btn" style="width: auto;">이 내용으로 적용</button>
                </div>
            </footer>
        </article>
    </div>

    <!-- [신규] 세계관 핵심 설정 다듬기 모달 -->
    <div id="refine-worldview-rule-modal" class="modal-container">
        <article style="max-width: 90vw; width: 1000px;">
            <header>
                <a href="#close" aria-label="Close" class="close"></a>
                <h3>✨ AI 핵심 설정 다듬기 제안</h3>
            </header>
            <div class="grid">
                <article>
                    <header><strong>원본 설정</strong></header>
                    <div id="refine-rule-original" style="white-space: pre-wrap; padding: 1rem; border: 1px solid var(--pico-muted-border-color); border-radius: 6px; min-height: 100px;"></div>
                </article>
                <article>
                    <header><strong>AI 제안</strong></header>
                    <div id="refine-rule-suggestion" style="white-space: pre-wrap; padding: 1rem; border: 1px solid var(--pico-muted-border-color); border-radius: 6px; min-height: 100px;"></div>
                </article>
            </div>
            <footer>
                <div class="grid" style="justify-content: flex-end; grid-template-columns: repeat(3, auto); gap: 0.5rem;">
                    <button id="refine-rule-reject-btn" class="secondary outline" style="width: auto;">반려</button>
                    <button id="refine-rule-reroll-btn" class="secondary" style="width: auto;">다시 시도 (Re-roll)</button>
                    <button id="refine-rule-accept-btn" style="width: auto;">이 내용으로 적용</button>
                </div>
            </footer>
        </article>
    </div>

    <!-- [신규] 시놉시스 구체화 모달 -->
    <div id="enhance-synopsis-modal" class="modal-container">
        <article style="max-width: 90vw; width: 1200px;">
            <header>
                <a href="#close" aria-label="Close" class="close"></a>
                <h3>✨ AI 시놉시스 구체화</h3>
            </header>
            <div class="grid">
                <article>
                    <header><strong>현재 시놉시스</strong></header>
                    <div id="enhance-synopsis-original" style="white-space: pre-wrap; padding: 1rem; border: 1px solid var(--pico-muted-border-color); border-radius: 6px; min-height: 100px; max-height: 200px; overflow-y: auto;"></div>
                </article>
                <article>
                    <header><strong>AI 제안</strong></header>
                    <div id="enhance-synopsis-suggestion" style="white-space: pre-wrap; padding: 1rem; border: 1px solid var(--pico-muted-border-color); border-radius: 6px; min-height: 100px; max-height: 200px; overflow-y: auto;">결과가 여기에 표시됩니다...</div>
                </article>
            </div>
            <div style="margin-top: 1rem;">
                <label for="synopsis-user-prompt"><strong>AI에게 요청할 내용:</strong></label>
                <div class="grid" style="margin-bottom: 0.5rem;">
                    <button type="button" class="synopsis-preset-btn secondary outline" data-prompt="300자 내외로 더 상세하게 확장해줘">📝 상세하게 확장</button>
                    <button type="button" class="synopsis-preset-btn secondary outline" data-prompt="문장을 자연스럽게 다듬어줘">✏️ 문장 다듬기</button>
                    <button type="button" class="synopsis-preset-btn secondary outline" data-prompt="더 흥미진진하고 구체적으로 만들어줘">🎬 더 흥미롭게</button>
                </div>
                <textarea id="synopsis-user-prompt" rows="3" placeholder="또는 직접 입력: 어떻게 수정하고 싶으신지 자유롭게 설명해주세요..."></textarea>
            </div>
            <details style="margin-top: 1rem;">
                <summary>참조할 정보 선택 (선택사항)</summary>
                <div class="grid">
                    <div>
                        <fieldset><legend><strong>참고할 캐릭터</strong></legend></fieldset>
                        <div id="synopsis-characters-container" class="checkbox-container" style="max-height: 150px; overflow-y: auto;">
                            <p>캐릭터 정보 로딩 중...</p>
                        </div>
                    </div>
                    <div>
                        <fieldset><legend><strong>참고할 서브 설정</strong></legend></fieldset>
                        <div id="synopsis-worldview-cards-container" class="checkbox-container" style="max-height: 150px; overflow-y: auto;">
                            <p>서브 설정 정보 로딩 중...</p>
                        </div>
                    </div>
                </div>
            </details>
            <footer>
                <div class="grid" style="justify-content: flex-end; grid-template-columns: repeat(3, auto); gap: 0.5rem;">
                    <button id="enhance-synopsis-reject-btn" class="secondary outline" style="width: auto;">반려</button>
                    <button id="enhance-synopsis-generate-btn" style="width: auto;">AI 구체화 실행</button>
                    <button id="enhance-synopsis-accept-btn" style="width: auto; display: none;">이 내용으로 적용</button>
                </div>
            </footer>
        </article>
    </div>

</body>
</html>
